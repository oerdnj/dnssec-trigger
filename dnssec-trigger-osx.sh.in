#!0SHELL0
#
# dnssec trigger for OSX

# the network state has changed, obtain a list of DHCP provided DNS servers.
# somehow in /Library/Preferences/SystemConfiguration/
#   com.apple.network.identification.plist  - list of configs seen
#   preferences.plist - list of what is entered in the config panel

# variable a is used because it is empty
ips=`awk "
/<key>DNS<\/key>/ {
	getline x
	while(x !~ /<\/dict>/) {
		if(x ~ /<array>/) {
			getline x
			while(x !~ /<\/array>/) {
				if(x ~ /<string>/)
					sub(/<string>/,a,x)
					sub(/<\/string>/,a,x)
					print x
				getline x
			}
		}
		getline x
	}
}
/<key>Timestamp<\/key>/ {
	exit
}
" < /Library/Preferences/SystemConfiguration/com.apple.network.identification.plist | sort -u `
# fix whitespace
ips=`echo $ips`

echo "dnssec-trigger detected DNS $ips"

# TODO do something with this

